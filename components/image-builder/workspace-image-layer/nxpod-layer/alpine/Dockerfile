# Copyright (c) 2020 TypeFox GmbH. All rights reserved.
# Licensed under the GNU Affero General Public License (AGPL).
# See License-AGPL.txt in the project root for license information.

# 'FROM ${BASE_IMAGE}' prepended here

###############################################################################
# REQUIRED
###############################################################################
# !!! We expect users to configure their containers as root !!!
USER root

# Copy config and layer script
COPY ./nxpod /var/nxpod

# Run layer
RUN /var/nxpod/layer.sh \
    # Remove the script itself
    # TODO Really necessary?
    && rm -f /var/nxpod/layer.sh

# Switch to user nxpod
USER nxpod

# Configure user shell
# TODO Remove this in the near future when we do not need ~/.bashrc appends/prepends any more
RUN \
    # REALLY do not print motd
    touch ~/.hushlogin                                                      && \
    # Configure shell
    BASH_RC=~/.bashrc; if [ -f "$BASH_RC" ]; then cp "$BASH_RC" ~/.bashrc-org; else touch ~/.bashrc-org; fi && \
    cat /var/nxpod/.bashrc-prepend > "$BASH_RC"                            && \
    cat ~/.bashrc-org >> "$BASH_RC"                                         && \
    cat /var/nxpod/.bashrc-append >> "$BASH_RC"

# This is necessary to override potential entrypoints in the base image which otherwise would have control over the startup process
# In most cases the workspace start just fails
ENTRYPOINT ["/theia/supervisor"]
CMD ["run"]
